<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <title>ระบบบันทึกหน่วยไฟฟ้าอัจฉริยะ</title>
    <link rel="stylesheet" href="">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <style>
        body{
            background-color:rgb(236, 236, 236)
        }
        #Head {
    font-size: 20px;
    background-color:#FFA500;
    color: black;
    border: 2px
  }
  div.bigroom{
    width: 100px;
    height: 150px;
    margin-left: 5%
  }
  div.room{
    border: 2px solid black;
    width: 100px;
    height: 90px;
  }
  .TextHead{
    font-size: 50px
    
  }
 
 
     #box { 
    border: 3px solid rgb(10, 10, 10);
    display: block;
    margin: auto;
    border-radius: 5%;
    padding: 10px;
    background-color: rgb(190, 225, 248)
}
body {font-family: Arial, Helvetica, sans-serif;}
* {box-sizing: border-box;}

/* Button used to open the contact form - fixed at the bottom of the page */
.open-button {
  background-color: #555;
  color: white;
  padding: 16px 20px;
  border: none;
  
  opacity: 0.8;
  
  bottom: 23px;
  right: 28px;
  width: 280px;
}

/* The popup form - hidden by default */
.form-popup {
  display: none;
  width: 1000px;
  border: 3px solid #f1f1f1;
  margin-left: auto;
 margin-right: auto;
    
}

/* Add styles to the form container */
.form-container {
  width: 100%;
  padding: 10px;
  background-color: white;
}

/* Full-width input fields */
.form-container {
  width: 100%;
  padding: 15px;
  margin: 5px 0 22px 0;
  border: none;
  background: rgb(249, 253, 253);
}

/* When the inputs get focus, do something */
.form-container input[type=text]:focus, .form-container input[type=password]:focus {
  background-color: #ddd;
  
}

/* Set a style for the submit/login button */
.form-container .btn {
  background-color: #4CAF50;
  color: white;
  padding: 16px 20px;
  border: none;
  cursor: pointer;
  width: 100%;
  margin-bottom:10px;
  opacity: 0.8;
}

/* Add a red background color to the cancel button */
.form-container .cancel {
  background-color: red;
}

/* Add some hover effects to buttons */
.form-container .btn:hover, .open-button:hover {
  opacity: 1;
}
</style>




</head>

<body>
    <div class="container-fluid" id="Head">
        <div class="class col-sm-12 ">
            <div class="row justify-content-center">
                <ul>
                    <img src="https://www.bpicc.com/images/2018/10/09/Logo_Intregrate.png" width="90px" height="90px"
                        alt="">
                </ul>
                <ul>
                    <img src="https://www.bpicc.com/images/2018/10/09/lg_wu.png" width="80px" height="90px" alt="">

                </ul>
                <div>
                    <ul>
                        <h1>ระบบบันทึกหน่วยไฟฟ้าอัจฉริยะ </h1>
                    </ul>
                    <ul>
                        <h5>(Smart energy monitoring system)</h2>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!--
  Extra small <576px   col
  small > 576      px  col-sm
  mediu, >= 768        col-md
  Large >=992 px       com-lg
  Extra Large >= 120px col-xl
-->

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-8 col-sm-12 text-center">

                <div id=" divPostNameBuild"></div>
                {{!-- <div id="box" class="col-sm-5 col-12 ">
                    <div class="row mt-4">
                        <div class="col">
                            <h5 text-center>หอพักpop</h5>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            มีผู้เช้า 5 ห้อง
                        </div>
                        <div class="col">
                            ห้องว่าง 10 ห้อง
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary mt-4" style="width:50%">จัดการหอพัก</button>
                </div> --}}
            </div>
            <button onclick="openForm()" type="button" class="btn btn-primary btn-md btn-block mt-4" style="width:50%;">เพิ่มหอพัก</button>


        </div>

    </div>
    <div class="container">
        <div class="row">
            <div class="form-popup" id="myForm">
                <form action="" class="form-container" method="" name="myForm" id="myForm">
                    <h1>สร้างหอพัก</h1>
                     <label for="exampleInputEmail1" style="color: red"><h5>*กรุณากรอกข้อมูลให้ครบทุกช่องไม่อย่างนั้นระบบจะไม่สามารถบันทึกได้</h5></label>
                    <div class="form-group">
                        <label for="exampleInputEmail1">ชื่อหอพัก</label>
                        <input name="nameBuilding" type="text" class="form-control" id="nameBuilding" placeholder="ชื่อหอพัก">
                    </div>
                    <div class="form-group">
                        <label for="exampleInputEmail1">เบอร์โทรติดต่อหอพัก</label>
                        <input name="phone" oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" type="number" maxlength="10" class="form-control" id="phone" placeholder="เบอร์โทรติดต่อหอพัก">
                    </div>
                    <div class="form-group">
                        <label for="exampleInputEmail1">emailติดต่อหอพัก</label>
                        <input name="email" type="email" class="form-control" id="email" placeholder="email ">
                    </div>
                    <div class="form-group">
                        <label for="exampleInputEmail1">วิธีคิดค่าน้ำ</label><br>
                        <input type="radio" name="water" value="rentmonth" required="required">คิดเเบบเหมาจ่ายต่อเดือน<br>
                        <input type="radio" name="water" value="rentunit" required="required">คิดตาม Unit ที่ใช้<br>
                        <input name="unitwater" oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" maxlength="4" type="number" class="form-control" id="unitwater" placeholder="ราคาค่าต่อเดือน หรือ ราคากี่บาทต่อ 1 uint">
                    </div>
                    <div class="form-group">
                        <label for="exampleInputEmail1">ค่าไฟฟ้าต่อหน่วย/บาท</label>
                        <input name="unitmeter" oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" maxlength="3" type="number" class="form-control" id="unitmeter" placeholder="ค่าไฟฟ้าต่อหน่วย">
                    </div>
                    <div class="form-group">
                        <label for="exampleInputEmail1">จำนวนชั้น</label>
                        <input max="99" name="inputfloor" type="number" class="form-control" id="inputfloor"
                            placeholder="จำนวนชั้น">
                    </div>
                    <div id="divPost"></div>

                    <button type="button" id="add" class="btn">ADD</button>
                    <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
                </form>
            </div>
        </div>

    </div>


    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
        crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

    <script>




        $(document).ready(function () {
            //    { { !--console.log($.cookie('name')) --} }
            console.log('cookie:', document.cookie)
            var myBuild
            var username = "{{username}}"
            var divPostNameBuild = document.getElementById('divPostNameBuild')
            var htmlStringg = '';
            var doc = "{{doc}}"
            var Admin = JSON.parse(decodeURI(doc))
            var data_admin = [];
            console.log('###################')
            console.log(Admin)
            var long_nameBuild = Admin.length
            console.log(long_nameBuild)
            for (let i = 0; i < long_nameBuild; i++) {
                data_admin[i] = Admin[i]
                console.log(data_admin[i])
                htmlStringg += '<div id="box" class="col-sm-5 col-12 "style="margin-bottom:5%"><div class="row mt-4"><div class="col"><h3 text-center id="NameB[' + i + ']">ชื่อหอพัก ' + data_admin[i].BuildingName + '</h3></div></div><button onclick="FunctionBuild(this.id)" type="button" class="btn btn-primary mt-4" style="width:50%"id="' + data_admin[i].BuildingName + ' "">จัดการหอพัก</button></div>'
            }
            document.getElementById(" divPostNameBuild").innerHTML = htmlStringg;
            console.log('nameAdmin', Admin)
            console.log('#########ppp#########')
            $('#inputfloor').on('input', function (e) {
                console.log('กดเพิ่มชั้น')
                var input = $(this);
                var val = input.val();
                if (val > 99) {
                    let s = val + ""
                    s = s.substring(0, s.length - 1)
                    let n = parseInt(s)
                    input.val(n);
                }
            })

            var htmlString = ''
            console.log('running')
            $('#inputfloor').on('input', function (e) {
                htmlString = ''
                var divPost = document.getElementById('divPost')
                divPost.innerHTML = ''
                var input = $(this);
                var val = input.val();
                console.log(val)
                for (i = 1; i <= val; i++) {
                    htmlString += '<p>ชั้น' + (i) + '<input  id="' + "floor" + i + '" type="number" /> ห้อง</p>'
                }
                divPost.insertAdjacentHTML('beforeend', htmlString);
            });

            $('#add').click(function () {
                console.log('######')
                 if (document.getElementById('nameBuilding').value == "") {
                    alert('Please Input BuildingName');
                    return false;
                } else if (document.getElementById('phone').value == "") {
                    alert('Please Input Phone Number ');
                    return false;
                } else if (document.getElementById('email').value == "") {
                    alert('Please Input Email');
                    return false;
                } else if (document.getElementById('unitwater').value =="") {
                    alert('Please input water meter');
                    return false;
                }else if (document.getElementById('unitmeter').value =="") {
                    alert('Please input Power meter unit');
                    return false;
                }
                var methodwater = $("input[name='water']:checked").val();
                var plicewater = document.getElementById("unitwater").value;
                var NameBuild = document.getElementById("nameBuilding").value;
                var Phone = document.getElementById("phone").value;
                var Email = document.getElementById("email").value;
                var Unitmeter = document.getElementById("unitmeter").value;
                var Inputfloor = document.getElementById("inputfloor").value;
                let floor = []

                for (let i = 0; i < Inputfloor; i++) {
                    let f = $('#floor' + (i + 1)).val()
                    console.log('Data is ddd', f)
                    floor.push(parseInt(f))
                }

                let myData = {}
                myData.adminAllow = username
                myData.BuildingName = NameBuild
                myData.UnitMeter = Unitmeter
                myData.BuildingPhone = Phone
                myData.BuildingEmail = Email
                myData.methodwater = methodwater
                myData.plicewater = plicewater



                let floorArray = []
                for (let i = 0; i < Inputfloor; i++) {
                    let floorData = {}
                    let roomArrayPerFloor = []


                    for (let j = 0; j < floor[i]; j++) {
                        let roomNumber = ''
                        if ((i + 1) <= 9) {
                            roomNumber = '0' + (i + 1)
                        } else {
                            roomNumber = '' + (i + 1)
                        }
                        if ((j + 1) <= 9) {
                            roomNumber += ('0' + (j + 1))
                        } else {
                            roomNumber += (j + 1)
                        }

                        let roomData = {
                            roomStatus: 'ว่าง',
                            payStatus: false,
                            roomNumber,
                            contract: '',

                        }
                        roomArrayPerFloor.push(roomData)
                    }
                    floorData.room = roomArrayPerFloor
                    floorData.number = '' + (i + 1)
                    floorArray.push(floorData)
                }

                myData.floor = floorArray

                console.log('Data is', myData)
                postData(myData);
                return false;
            });

        });
        function postData(myData) {

            var url = "https://electricitymeter.herokuapp.com/postBuilding";
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    console.log('res is', xhr.responseText)
                    // if success go login page
                    alert(xhr.responseText)
                    window.location.reload(true);

                } else {
                    //alert('can not create user! Pls try again.')
                }
            };
            var data = JSON.stringify({ adminAllow: myData.adminAllow, BuildingName: myData.BuildingName, UnitMeter: myData.UnitMeter, BuildingPhone: myData.BuildingPhone, BuildingEmail: myData.BuildingEmail, floor: myData.floor, methodwater: myData.methodwater, plicewater: myData.plicewater });
            xhr.send(data);
        }
        function openForm() {
            document.getElementById("myForm").style.display = "block";
        }

        function closeForm() {
            document.getElementById("myForm").style.display = "none";
        }

        function FunctionBuild(BuildingName) {
            console.log("หอพักชื่่อ :", BuildingName)
            // window.location.href = 'http://localhost:3000/test';

            //  window.location.href = 'http://localhost:3000/HOME?BuildingName=' + BuildingName

            var ourRequest = new XMLHttpRequest();
            ourRequest.open('GET', 'https://electricitymeter.herokuapp.com/getwater/' + BuildingName)
            ourRequest.onload = function () {
                var ourData = JSON.parse(ourRequest.responseText);

                console.log('data : ', ourData)
                gethomewater(ourData, BuildingName)
                return false;
            }
            ourRequest.send();
            function gethomewater(ourData, BuildingName) {
                //console.log(ourData[0].methodwater)
                if (ourData[0].methodwater == 'rentmonth') {
                    window.location.href = 'https://electricitymeter.herokuapp.com/HOME?BuildingName=' + BuildingName
                } else if (ourData[0].methodwater == 'rentunit') {
                    window.location.href = 'https://electricitymeter.herokuapp.com/HOME?BuildingName=' + BuildingName
                }
            }

            /*  var url = "http://localhost:3000/getHome";
              var xhr = new XMLHttpRequest();
              xhr.open("POST", url, true);
              xhr.setRequestHeader("Content-Type", "application/json");
              xhr.onreadystatechange = function () {
                  if (xhr.readyState === 4 && xhr.status === 200) {
                      document.documentElement.innerHTML = xhr.responseText
                      //console.log('res is', xhr.responseText)
                      // if success go login page
                      // alert('success')
                  } else {
                      //alert('can not create user! Pls try again.')
                  }
              };
              var data = JSON.stringify({ BuildingName });
              xhr.send(data); 
              */
        }


    </script>







</body>

</html>